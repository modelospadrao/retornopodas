<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MODELO RETORNO DE CAMPO LINHA VIVA PREVETIVA/CORRETIVA</title>
  <link rel="icon" href="pesada.png" type="image/png">
  <!-- Importa a biblioteca html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
  <style>
    /* Estilos Gerais e do Formulário */
    body { 
      font-family: Cambria, Cochin, Georgia, Times, sans-serif; 
      overscroll-behavior-y: none; 
    }
    .container { 
      width: 90%; 
      margin: auto; 
    }
    textarea { 
      width: 100%; 
      height: 469px; 
    }
    .hidden { 
      display: none; 
    }
    input[type="text"], input[type="date"], input[type="number"], .supervisor-box, .preview-text {
      width: 100%; 
      padding: 9px; 
      margin: 6px 0;
      font-size: 14px; 
      border: 1px solid #ddd;
      text-transform: uppercase; 
      background-color: #f0f0f0;
    }
    input[type="tel"], select, input {
      width: 100%; 
      padding: 9px; 
      margin: 6px 0;
      font-size: 14px; 
      border: 1px solid #ddd;
      text-transform: uppercase; 
      background-color: #f0f0f0;
    }
    /* Botões do Formulário */
    .button-default {
      border: 1px solid black; 
      padding: 8px 16px; 
      margin: 5px;
      background-color: #fff; 
      cursor: pointer; 
      font-size: 14px; 
      border-radius: 4px; 
      transition: all 0.3s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .button-default.selected {
      background-color: #000; 
      color: #fff; 
      border: 1px solid #000;
    }
    .button-default:hover { 
      box-shadow: 0 0 10px rgba(0,0,0,0.2); 
    }
    .button-gerarMensagem {
      background-color: #616964; 
      color: white; 
      padding: 8px 16px; 
      margin: 5px;
      cursor: pointer; 
      font-size: 14px; 
      border-radius: 4px;
      transition: all 0.3s ease; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .button-enviarWhatsApp {
      background-color: #00b145; 
      color: white; 
      padding: 8px 16px; 
      margin: 5px;
      cursor: pointer; 
      font-size: 14px; 
      border-radius: 5px;
      transition: all 0.3s ease; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .clear-button {
      background-color: #f44336; 
      color: white; 
      padding: 8px 16px; 
      margin: 5px;
      cursor: pointer; 
      font-size: 14px; 
      border-radius: 4px;
      transition: all 0.3s ease; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .preview-box {
      border: 1px solid #ddd; 
      padding: 10px; 
      margin-top: 20px;
      background-color: #f0f0f0; 
      white-space: pre-wrap;
      font-family: monospace; 
      font-size: 14px;
    }
    /* Botões Sim/Não */
    .button-yes {
      background-color: #4CAF50; 
      color: white; 
      border: 1px solid #4CAF50;
      padding: 8px 16px; 
      font-size: 14px; 
      border-radius: 4px;
      cursor: pointer; 
      margin: 0 5px;
    }
    .button-yes.selected {
      background-color: #000; 
      color: #fff; 
      border: 1px solid #000;
    }
    .button-no {
      background-color: #ff0000; 
      color: #ffffff; 
      padding: 8px 16px; 
      font-size: 14px; 
      border-radius: 4px;
      cursor: pointer; 
      margin: 0 5px;
    }
    .button-no.selected {
      background-color: #000; 
      color: #fff; 
      border: 1px solid #000;
    }
    /* Global Clock */
    #global-clock {
      position: fixed; 
      top: 10px; 
      left: 10px;
      font-size: 24px; 
      font-family: 'Courier New', Courier, monos-serif;
      color: #fff; 
      background-color: #000; 
      padding: 10px;
      border-radius: 8px; 
      z-index: 1001; 
      display: none;
    }
    /* Popups padrão */
    .popup {
      display: none; 
      position: fixed;
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px; 
      background-color: rgba(0,0,0,0.8);
      color: white; 
      font-size: 16px; 
      border-radius: 5px;
      z-index: 1100; 
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      text-align: left;
    }
    .popup-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .popup-buttons button {
      flex: 1 1 auto;
      white-space: normal;
      word-wrap: break-word;
      font-size: 12px;
      padding: 6px 10px;
      min-width: 120px;
      border-radius: 4px;
    }
    /* Popup de confirmação */
    .popup-confirm {
      background-color: #fff; 
      color: red;            
      font-size: 16px;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1200; 
      display: none;
    }
    .popup-confirm .btn-sim {
      background-color: green; 
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .popup-confirm .btn-nao {
      background-color: red; 
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    /* Overlay */
    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 500; 
      display: none;
    }
    #clickOverlay {
      position: fixed; 
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background-color: transparent; 
      z-index: 2000;
      display: none;
    }
    /* Popup ao clicar no overlay */
    #body-popup {
      display: none; 
      position: fixed;
      top: 20px; 
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.85);
      color: #fff; 
      padding: 15px 20px;
      border-radius: 8px; 
      z-index: 2500; 
      font-size: 18px;
      cursor: pointer;
    }
    /* Botão Reiniciar */
    #reset-button {
      border: 1px solid black; 
      padding: 8px 16px;
      background-color: #000; 
      color: white; 
      cursor: pointer;
      font-size: 20px; 
      border-radius: 32px; 
      margin: 10px;
      display: block; 
      width: fit-content; 
      margin-left: auto; 
      margin-right: auto;
      position: relative; 
      z-index: 3000;
    }
    /* Popup de aviso de PDF não salvo */
    #pdf-warning-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #ffcccc;
      color: #000;
      font-size: 16px;
      border: 2px solid #ff0000;
      border-radius: 8px;
      z-index: 2001;
      text-align: center;
      pointer-events: auto;
    }
    /* Popup de lembrete de PDF não salvo */
    #pdf-reminder-popup {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px; 
      background-color: #ffcccc;
      color: #000;
      font-size: 16px;
      border: 4px solid #ff0000;
      border-radius: 8px;
      z-index: 1500;
      text-align: center;
    }
    .input-container {
      display: flex;
      flex-wrap: nowrap; /* Permite quebra de linha */
      gap: 23px;
      justify-content: flex-start; /* Alinha os itens à esquerda */
    }
    .input-group {
      flex: 0 0 calc(50% - 11.5px);
    }
    .input-container label {
      display: block;
      width: 100%;
      margin-bottom: -1px;
      text-align: left;
    }
    .input-container input {
      width: 70%;
      padding: 4px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      text-align: left;
    }
    
    /* Estilos para os botões e o campo somente leitura */
    .button-default {
      border: 1px solid black;
      padding: 8px 16px;
      margin: 5px;
      background-color: #fff;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .button-default.selected {
      background-color: #000;
      color: #fff;
      border: 1px solid #000;
    }
    #selectedTeamType {
      width: 95%;
      padding: 9px;
      margin: 6px 0;
      font-size: 14px;
      border: 1px solid #ddd;
      background-color: #f0f0f0;
      text-transform: uppercase;
    }
    /* Container da seção */
    #teamSelection {
      margin: 20px 0;
      padding: 10px;
      border: 2px solid #000;
    }
    #teamSelection h3 {
      margin-bottom: 10px;
    }
    #teamButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
        #podaUnitExtras input {
      width: 80px;      /* ajuste para o tamanho que quiser */
      max-width: 100%;  /* impede extrapolar o container */
    }

    /* para os campos da poda em m² */
    #podaExtras input {
      width: 80px;      /* ou 60px, 100px, em%, em, etc */
      max-width: 100%;
    }
  </style>
</head>
<body>
  <!-- Overlays e Popups -->
  <div id="popupOverlay"></div>
  <div id="clickOverlay"></div>
  <div id="global-clock"></div>
  <div id="update-popup" class="popup" style="font-size: 15px;">
    <p>⚠️ NOTAS DE ATUALIZAÇÃO!!!<br><br>
       1️⃣ O campo "Pré-Visualização da Mensagem" agora é preenchido automaticamente sempre que um valor é alterado.<br>
       2️⃣ Foram adicionadas mensagens pré‑formatadas quando marcada a opção ("NÃO").<br>
       3️⃣ Incluídos alertas para lembrar de salvar o arquivo em PDF.<br>
       4️⃣ Agora, o sistema renomeia automaticamente o arquivo PDF para facilitar sua localização, com base no retorno do preenchimento diário.<br>
       5️⃣ Alguns campos foram atualizados, exigindo o preenchimento obrigatório!<br>
       6️⃣ Foram adicionadas novas opções no questionário.<br>
       7️⃣ Foram inseridos campos para o horário de início e fim da atividade.<br>
       8️⃣ Foi ajustada a condição para salvar primeiro o PDF em seguida encaminhar a mensagem via Whatsapp.<br>
       9️⃣ Foi ajustado o estilo do Layout, para coincidir com a ordem na "Pré-Visualização da Mensagem"<br><br>
      <br>
      <button onclick="closeUpdatePopup(); hideOverlay();" style="font-size: 15px; padding: 7px 125px; border-radius: 14px; background-color: #fff; color: black; border: none; cursor: pointer; display: block; margin: 0 auto;">
        Fechar
      </button>
  </div>
  <div id="welcome-popup" class="popup">
    <p>Bem-vindo! Deseja iniciar?</p>
    <div class="popup-buttons">
      <button class="button-yes" onclick="startSprint()">Sim</button>
      <button class="button-no" onclick="handleNoSprint()">Não</button>
    </div>
  </div>
  <div id="yes-notification-popup" class="popup">
    <p>Os campos estão liberados para edição. O contador de tempo foi ativado.</p>
  </div>
  <div id="no-notification-popup" class="popup">
    <p>Edição cancelada!</p>
  </div>
  <div id="gerar-popup" class="popup">
    <p>Mensagem Gerada!</p>
    <button onclick="document.getElementById('gerar-popup').style.display='none'; hideOverlay();">Fechar</button>
  </div>
  <div id="limpar-popup" class="popup">
    <p>Mensagem limpa com sucesso!</p>
    <button onclick="document.getElementById('limpar-popup').style.display='none'; hideOverlay();">Fechar</button>
  </div>
  <div id="encaminhar-popup" class="popup">
    <p>Mensagem encaminhada com sucesso!<br>
       No final do dia o responsável deverá incrementar no formulário essas evidências!</p>
    <button onclick="document.getElementById('encaminhar-popup').style.display='none'; hideOverlay();">Fechar</button>
  </div>
  <div id="popup" class="popup">Mensagem Copiada!</div>
  <div id="options-popup" class="popup"></div>
  <div id="confirm-popup" class="popup"></div>
  <!-- Popup para Reiniciar sem Salvar PDF -->
  <div id="pdf-warning-popup" class="popup">
    <p>Você NÃO salvou o PDF!<br>Tem certeza que deseja reiniciar sem salvar o PDF?</p>
    <div class="popup-buttons">
      <button onclick="confirmReset()">Sim, reiniciar</button>
      <button onclick="cancelReset()">Cancelar</button>
    </div>
  </div>
  <!-- Popup para campos obrigatórios -->
  <div id="obrigatorio-popup" class="popup">
    <p>Por favor, preencha os seguintes campos obrigatórios:<br><!-- Mensagem definida dinamicamente --></p>
    <div class="popup-buttons">
      <button onclick="document.getElementById('obrigatorio-popup').style.display='none';">Fechar</button>
    </div>
  </div>
  <div id="pdf-reminder-popup" class="popup">
    <p>Atenção: Você não salvou o PDF! Salve-o para arquivar a evidência.</p>
  </div>
  <div id="body-popup" class="popup" onclick="this.style.display='none'; event.stopPropagation();">
    ⚠️ ATENÇÃO: Todos os campos estão bloqueados!<br>
    Reinicie a página utilizando o botão "REINICIAR".
  </div>
  
  <div class="container">
    <h2 style="text-align: center; font-size: 25px; font-weight: bold; color: #e63946;">
      MODELO RETORNO DE CAMPO<br>LINHA VIVA PREVETIVA/CORRETIVA
    </h2>
    <h2 style="text-align: center; font-size: 21px; font-weight: bold; color: #000;">(Versão 4.0)</h2>
    
    <!-- Início do Formulário -->
    <div id="formFields">
      <input type="text" id="outroLead" class="hidden" placeholder="Digite o nome do LEAD">
      <h2 style="color: #000000; font-size: 22px; text-align: center; margin: 20px 0; border-bottom: 5px solid #000000;">
      Informe qual tipo de  Equipe</h2>
      <!-- Seção para seleção do Tipo de Equipe -->
      <div id="teamSelection">
          <div id="teamButtons">
          <button type="button" class="button-default" onclick="selectTeamType('LINHA VIVA PROGRAMADA', this)">(LR/LC/LE/LL) <BR>PROGRAMADA</button>
          <button type="button" class="button-default" onclick="selectTeamType('LINHA VIVA EMERGENCIA', this)">(LR/LC/LE/LL)<BR>EMERGENCIA</button>
          <button type="button" class="button-default" onclick="selectTeamType('MANUTENÇÃO PROGRAMADA', this)">(EP/PP)<BR>PROGRAMADA</button>
          <button type="button" class="button-default" onclick="selectTeamType('MANUTENÇÃO EMERGENCIA', this)">(EP/PP) <BR>EMERGENCIA</button>
          <button type="button" class="button-default" onclick="selectTeamType('PODA EMERGENCIA', this)">(PD) <BR>EMERGENCIA</button>
          <button type="button" class="button-default" onclick="selectTeamType('EMERGENCIA', this)">(SI/SG/RD) <BR>EMERGENCIA</button>
        </div>
        <label for="pessoa">Tipo de Equipe:</label>
        <!-- Campo somente leitura que exibirá o tipo de equipe selecionado -->
        <input type="text" id="selectedTeamType" readonly placeholder="Tipo de Equipe Selecionada">
      </div>
      
      <h2 style="color: #000000; font-size: 22px; text-align: center; margin: 20px 0; border-bottom: 5px solid #000000;">
      Preencha os dados da Equipe</h2>
      
      <!-- Campo Nome do Componente -->
    <label for="pessoa">Nome do Componente:</label>
    <select id="pessoa" style="width:100%"></select>
            
      <label for="lead">LEAD:</label>
    <select id="lead" style="width:100%"></select>
      
      <div class="input-container">
        <div class="input-group">
          <label for="br1">BR LÍDER:</label>
          <input type="tel" id="br1" value="BR" maxlength="12" pattern="\d*" inputmode="numeric" placeholder="12 DÍGITOS"
                 onkeydown="enforcePrefix(event, 'BR')" oninput="fixPrefixInput(this, 'BR')">
        </div>
      </div>
      
      <h2 style="color: #e63946; font-size: 22px; text-align: center; margin: 20px 0; border-bottom: 5px solid #e63946;">
        Preencha dados da Documentação
      </h2>
      <label>OT/ANE:</label>
      <input type="tel" id="ot_ane" maxlength="7" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS">
      
      <label>SGM:</label>
      <input type="tel" id="sgm" maxlength="10" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS">
     
      
      
      <label>BA:</label>
      <input type="tel" id="ba" value="BA" maxlength="10" pattern="\d*" inputmode="numeric"
             placeholder="INSIRA APENAS NÚMEROS, 8 DÍGITOS"
             onkeydown="enforcePrefix(event, 'BA')" oninput="fixPrefixInput(this, 'BA')">
      
      <label>SGD:</label>
      <input type="tel" id="sgd" maxlength="8" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS, 8 DÍGITOS">
      
      <label>INC:</label>
      <input type="tel" id="inc" maxlength="8" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS SEM ZEROS, 8 DÍGITOS">
      
      <label>DT:</label>
      <input type="tel" id="dt" value="DT" maxlength="10" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS SEM ZEROS, 8 DÍGITOS"
       onkeydown="enforcePrefix(event, 'DT')" oninput="fixPrefixInput(this, 'DT')">
      
      <label>APR DIGITAL:</label>
      <input type="tel" id="apr" maxlength="7" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS, 7 DÍGITOS">
      
      <label>APR MANUAL (PAPEL):</label>
      <input type="tel" id="apr2" maxlength="11" pattern="\d*" inputmode="numeric" placeholder="INSIRA APENAS NÚMEROS, 11 DÍGITOS">
      
      <label>5RO:</label>
      <div id="cincoRO-container">
        <button type="button" class="button-default" id="cincoRO-sim" onclick="selectCincoRO('SIM', this)">SIM</button>
        <button type="button" class="button-default" id="cincoRO-nao" onclick="selectCincoRO('NÃO', this)">NÃO</button>
        <input type="text" id="cincoRO-input" class="hidden" readonly>
      </div>
      
    <h2 style="color: #e63946; font-size: 22px; text-align: center; margin: 20px 0; border-bottom: 5px solid #e63946;">
        Preencha Informação de campo!
      </h2>
      
      <label>TRAFO:</label>
      <input type="text" id="traf" maxlength="10" pattern="^[A-Za-z0-9]{1,10}$" placeholder="INSIRA APENAS LETRAS E NÚMEROS, MÁXIMO 10 DÍGITOS">
      
      <label>TOMBAMENTO:</label>
      <input type="text" id="Tomb" maxlength="10" pattern="^[A-Za-z0-9]{1,10}$" placeholder="INSIRA APENAS NÚMEROS, MÁXIMO 10 DÍGITOS">
      
      <label>ESTRUTURA:</label>
      <input type="text" id="estrut" maxlength="10" pattern="^[A-Za-z0-9]{1,10}$" placeholder="INSIRA APENAS LETRAS E NÚMEROS, MÁXIMO 10 DÍGITOS">
      
      <label>ALIM:</label>
      <input type="text" id="alim" maxlength="7" pattern="[A-Za-z0-9]{7}" placeholder="INSIRA APENAS LETRAS E NÚMEROS SEM ESPAÇOS OU TRAÇOS, 7 DÍGITOS">
      
      <label>ENDEREÇO:</label>
      <input type="text" id="endereco" placeholder="INSIRA ENDEREÇO COMPLETO">
      <br><br>
      
      <h2 style="color: #e63946; font-size: 22px; text-align: center; margin: 20px 0; border-bottom: 5px solid #e63946;">
        Descreva detalhes da Atividade
      </h2>
      <label>DATA:</label>
      <input type="date" id="data" required>
      
      <div class="input-container">
        <div class="time-input-group">
          <label for="start-time">Horário de Início:</label>
          <input type="tel" inputmode="numeric" id="start-time" maxlength="5" placeholder="HH:mm" oninput="insertColon(this)">
        </div>
        <div class="time-input-group">
          <label for="end-time">Horário Final:</label>
          <input type="tel" inputmode="numeric" id="end-time" maxlength="5" placeholder="HH:mm" oninput="insertColon(this)">
        </div>
      </div>
      
      <!-- Substitua este trecho HTML no seu formulário -->
        <h3>Poda Realizada (unidades)</h3>
        <div id="PODAUNIT-container">
          <button type="button" id="PODAUNIT-BT" class="button-default"
                  onclick="selectPODAUnitOption('BT', this)">BT</button>
          <button type="button" id="PODAUNIT-MT" class="button-default"
                  onclick="selectPODAUnitOption('MT', this)">MT</button>
          <button type="button" id="PODAUNIT-NAO" class="button-default"
                  onclick="selectPODAUnitRealizada(this)">
            NÃO FOI REALIZADO PODA (Unidades)
          </button><br>
          <input type="text" id="PODAUNIT-input" class="hidden" readonly>
        </div>

        <div id="podaUnitExtras" class="hidden">
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <label for="qtdPodasUnit">Qtd. de Podas (unidades):</label>
              <input type="number" id="qtdPodasUnit" max="999" placeholder="Ex: 3"
                     oninput="
                       this.value = this.value.replace(/\D/g,'').slice(0,3);
                       atualizarTotalPodasUnit();
                       gerarMensagem();
                     ">
            </div>
            <div style="flex: 1;">
              <label for="totalUnit">Total de Unidades:</label>
              <input type="text" id="totalUnit" readonly placeholder="Total unidades">
            </div>
          </div>
      </div>
      
       <!-- Grupo de botões para PODA -->
      <h3>Poda Realizada (m²)</h3>
      <div id="PODA-container">
        <button type="button" class="button-default" id="PODA-BT" onclick="selectPODAOption('BT', this)">BT</button>
        <button type="button" class="button-default" id="PODA-MT" onclick="selectPODAOption('MT', this)">MT</button>
        <button type="button" class="button-default" id="PODA-NAO" onclick="selectPODARealizada(this)">NÃO FOI REALIZADO PODA (m²)</button><br>
        <input type="text" id="PODA-input" class="hidden" readonly>
      </div>

      <!-- Container extra para dados de poda (quantidade, m² e total) – exibido se BT/MT estiver selecionado -->
      <div id="podaExtras" class="hidden">
        <div style="display: flex; gap: 10px;">
          <div style="flex: 1;">
            <label for="qtdPodas">Qtd. de Podas (unidades):</label>
            <input type="number" id="qtdPodas" max="999" placeholder="Ex: 3" oninput="atualizarTotalPodas(); gerarMensagem()">
          </div>
          <div style="flex: 1;">
            <label for="totalM2">Soma Total m²:</label>
            <input type="text" id="totalM2" readonly placeholder="Total m²">
          </div>
        </div>
        <label for="m2PorPoda">Metros quadrados realizados por pontos:</label>
        <input type="number" id="m2PorPoda" step="any" placeholder="Ex: 15" oninput="atualizarTotalPodas(); gerarMensagem()">
      </div>
      
      <!-- Campos opcionais: Serviço, Material, Sucata, Recurso -->
      <h3>Serviço Realizado?</h3>
      <button class="button-default" data-field="servico" onclick="toggleEditableField('servico', 'sim', this)">Sim</button>
      <button class="button-default" data-field="servico" onclick="toggleEditableField('servico', 'nao', this)">Não</button>
      <div id="servico" class="hidden">
        <label>Descrição:</label>
        <input type="text" class="preview-text" id="descricaoServico">
      </div>
      
      <h3>Material Utilizado?</h3>
      <button class="button-default" data-field="material" onclick="toggleEditableField('material', 'sim', this)">Sim</button>
      <button class="button-default" data-field="material" onclick="toggleEditableField('material', 'nao', this)">Não</button>
      <div id="material" class="hidden">
        <label>Descrição:</label>
        <input type="text" class="preview-text" id="descricaoMaterial">
      </div>
      
      <h3>Devolução Sucata Gerada?</h3>
      <button class="button-default" data-field="sucata" onclick="toggleEditableField('sucata', 'sim', this)">Sim</button>
      <button class="button-default" data-field="sucata" onclick="toggleEditableField('sucata', 'nao', this)">Não</button>
      <div id="sucata" class="hidden">
        <label>Descrição:</label>
        <input type="text" class="preview-text" id="descricaoSucata">
      </div>
      
      <h3>Necessário Envio de outra Equipe?</h3>
      <button class="button-default" data-field="recurso" onclick="toggleEditableField('recurso', 'sim', this)">Sim</button>
      <button class="button-default" data-field="recurso" onclick="toggleEditableField('recurso', 'nao', this)">Não</button>
      <div id="recurso" class="hidden">
        <label>Descrição:</label>
        <input type="text" class="preview-text" id="descricaoRecurso">
      </div>
      
      <br><br>
      
      
      <br><br>
      <h3>Pré-Visualização da Mensagem</h3>
      <div id="previewBox" class="preview-box"></div>
      
      <div class="share-buttons">
        <button class="button-gerarMensagem" onclick="gerarMensagem(); document.getElementById('gerar-popup').style.display='block'; showOverlay();">
        Gerar Mensagem
        </button>
        <button id="whatsappButton" class="button-enviarWhatsApp" onclick="enviarWhatsApp()" disabled>Encaminhar para WhatsApp</button>
        <button id="pdfButton" class="button-default" onclick="savePdf()">Salvar PDF</button>
        </div>
      <br>
      <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Enel_Group_logo.svg" alt="Logo ENEL" style="width: 193px; height: auto; display: block; margin: auto;">
    </div>
  </div>
  
  <p style="text-align: center; font-style: italic; font-family: 'Courier New', Courier, monospace; margin-top: 40px;">
    © 2025 Emanuel Aguiar (Assistente Administrativo Insourcing - Enel CE)<br>
    Todos os direitos reservados.
  </p>
  
  <div class="container" style="text-align: center; margin-top: 20px;">
    <button id="reset-button" style="font-style: italic; font-family: 'Courier New', Courier, monospace; margin-top: 10px;" onclick="resetSprint()">REINICIAR</button>
  </div>
  
  <script>
    // Funções para exibir/ocultar overlay
    function showOverlay() {
      document.getElementById('popupOverlay').style.display = 'block';
    }
    function hideOverlay() {
      document.getElementById('popupOverlay').style.display = 'none';
    }
    document.getElementById('popupOverlay').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('atencao-popup').style.display = 'block';
    });
    
    // Variáveis globais
    let globalTimerStart = null;
    let globalTimerInterval = null;
    let pdfSaved = false;
    let lastInteraction = Date.now();
    let currentOptionField = "";
    let currentOptionButton = null;
    
    // Variáveis para os campos opcionais
    let respServico = "";
    let respMaterial = "";
    let respSucata = "";
    let respRecurso = "";
    
    // Variável para o campo 5RO
    let cincoROValue = "";
    
    let notas = {
      servico: "",
      material: "",
      sucata: "",
      recurso: ""
    };
    let fieldsAnswered = {
      servico: false,
      material: false,
      sucata: false,
      recurso: false
    };
    
    const optionsForField = {
      servico: ["CARROS NO LOCAL", "FALTA DE TEMPO HÁBIL", "DOCUMENTOS DIVERGENTE", "CHUVA", "UMIDADE 85% SUPERIOR PREVISTO NA IT 1403", "OUTROS", "ÁREA DE RISCO"],
      material: ["NÃO FOI SOLICITADO MATERIAL PARA ESTE ATENDIMENTO", "NÃO HOUVE UTILIZAÇÃO DE MATERIAL", "APOIO DE OUTRA EQUIPE", "OUTROS"],
      sucata: ["SEM SUCATA GERADA", "OUTROS"],
      recurso: ["ENVIAR EQUIPE PESADA", "NECESSARIO EQUIPE DE PODA", "NECESSARIO RECOLHA DE RESÍDUOS", "NECESSÁRIO EQUIPE DO EMERGENCIAL", "OUTROS"]
    };
    const messagesForField = {
      servico: "SELECIONE O MOTIVO:",
      material: "SELECIONE O MOTIVO:",
      sucata: "SELECIONE O MOTIVO:",
      recurso: "SELECIONE O MOTIVO:"
    };
    
    // Remoção da filtragem para o campo que usa prefixo
    document.addEventListener("DOMContentLoaded", function () {
      const camposNumericos = ["ot_ane", "sgd", "inc"];
      camposNumericos.forEach(id => {
        document.getElementById(id).addEventListener("input", function () {
          this.value = this.value.replace(/\D/g, '');
        });
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const camposValidos = ["traf", "estrut", "alim"];
      camposValidos.forEach(id => {
        document.getElementById(id).addEventListener("input", function () {
          this.value = this.value.replace(/[^a-zA-Z0-9]/g, '');
        });
      });
    });
    
    // Função para os campos opcionais
    function toggleEditableField(field, choice, btn) {
      const container = document.getElementById(field);
      const buttons = document.querySelectorAll("button[data-field='" + field + "']");
      buttons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    
      if (field === "recurso") {
        if (choice === 'sim') {
          container.classList.add('hidden');
          let customOptions = ["ENVIAR EQUIPE PESADA", "NECESSARIO EQUIPE DE PODA", "NECESSARIO RECOLHA DE RESÍDUOS", "NECESSÁRIO EQUIPE DO EMERGENCIAL", "OUTROS"];
          showOptionsPopup(field, customOptions);
          respRecurso = "SIM";
        } else { 
          container.classList.remove('hidden');
          document.getElementById('descricaoRecurso').value = "SERVIÇO CONCLUÍDO 100%";
          respRecurso = "NÃO";
          fieldsAnswered[field] = true;
        }
        gerarMensagem();
        return;
      }
      
      if (choice === 'sim') {
        container.classList.remove('hidden');
        if (field === "servico") { document.getElementById('descricaoServico').value = ""; respServico = "SIM"; }
        if (field === "material") { document.getElementById('descricaoMaterial').value = ""; respMaterial = "SIM"; }
        if (field === "sucata") { document.getElementById('descricaoSucata').value = ""; respSucata = "SIM"; }
        fieldsAnswered[field] = true;
      } else {
        container.classList.add('hidden');
        showOptionsPopup(field);
      }
      gerarMensagem();
    }
    
    function selectCincoRO(value, btn) {
      document.getElementById('cincoRO-sim').classList.remove('selected');
      document.getElementById('cincoRO-nao').classList.remove('selected');
      btn.classList.add('selected');
      cincoROValue = value;
      let input = document.getElementById('cincoRO-input');
      input.classList.remove('hidden');
      input.value = value;
      gerarMensagem();
    }
    
    // Variável global para armazenar os valores selecionados do TIPO DE PODA (BT e/ou MT)
    let podaValues = [];
    // Variável para indicar se o usuário selecionou "NÃO FOI REALIZADO PODA"
    let podaNaoRealizada = false;
    
    function selectPODAOption(value, btn) {
      // Se o botão "NÃO FOI REALIZADO PODA" estiver selecionado, desmarca-o
      if (document.getElementById("PODA-NAO").classList.contains("selected")) {
        document.getElementById("PODA-NAO").classList.remove("selected");
        podaNaoRealizada = false;
      }
      // Toggle: processa a seleção dos botões BT e MT
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        podaValues = podaValues.filter(v => v !== value);
      } else {
        btn.classList.add("selected");
        podaValues.push(value);
      }
    
      const input = document.getElementById("PODA-input");
      if (podaValues.length > 0) {
        input.classList.remove("hidden");
        input.value = podaValues.join("/");
        // Exibe os campos extras
        document.getElementById('podaExtras').classList.remove("hidden");
      } else {
        input.classList.add("hidden");
        input.value = "";
        document.getElementById('podaExtras').classList.add("hidden");
      }
      gerarMensagem();
    }
    
    function selectPODARealizada(btn) {
      // Ao selecionar "NÃO FOI REALIZADO PODA", desmarca BT e MT e limpa o array
      document.getElementById("PODA-BT").classList.remove("selected");
      document.getElementById("PODA-MT").classList.remove("selected");
      podaValues = [];
      // Toggle: se o botão já estiver selecionado, desmarque; senão, marque
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        podaNaoRealizada = false;
        document.getElementById("PODA-input").classList.add("hidden");
        document.getElementById("PODA-input").value = "";
      } else {
        btn.classList.add("selected");
        podaNaoRealizada = true;
        document.getElementById("PODA-input").classList.remove("hidden");
        document.getElementById("PODA-input").value = "NÃO FOI REALIZADO PODA (m²)";
        document.getElementById('podaExtras').classList.add("hidden");
        document.getElementById('qtdPodas').value = "";
        document.getElementById('m2PorPoda').value = "";
        document.getElementById('totalM2').value = "";
      }
      gerarMensagem();
    }
    
    // Atualiza o campo de Total m², com base na quantidade e metros por poda
    function atualizarTotalPodas() {
      let qtd = document.getElementById('qtdPodas').value;
      let m2 = document.getElementById('m2PorPoda').value;
      if(qtd.trim() !== "" && m2.trim() !== "") {
          let total = Number(qtd) * Number(m2);
          document.getElementById('totalM2').value = total;
      } else {
          document.getElementById('totalM2').value = "";
      }
    }
    let unitValues = [];
    let unitNaoRealizada = false;

    function selectPODAUnitOption(value, btn) {
      // se vinha de "não realizado", limpa aquele estado primeiro
      if (unitNaoRealizada) {
        document.getElementById("PODAUNIT-NAO").classList.remove("selected");
        unitNaoRealizada = false;
      }
      // toggle do BT/MT
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        unitValues = unitValues.filter(v => v !== value);
      } else {
        btn.classList.add("selected");
        unitValues.push(value);
      }
      // atualiza input e container extra
      const input = document.getElementById("PODAUNIT-input");
      if (unitValues.length > 0) {
        input.classList.remove("hidden");
        input.value = unitValues.join("/");
        document.getElementById("podaUnitExtras").classList.remove("hidden");
      } else {
        input.classList.add("hidden");
        input.value = "";
        document.getElementById("podaUnitExtras").classList.add("hidden");
      }
      gerarMensagem();
    }

    function selectPODAUnitRealizada(btn) {
      // desmarca BT e MT
      document.getElementById("PODAUNIT-BT").classList.remove("selected");
      document.getElementById("PODAUNIT-MT").classList.remove("selected");
      unitValues = [];

      // toggle no "não realizado"
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        unitNaoRealizada = false;
        document.getElementById("PODAUNIT-input").classList.add("hidden");
        document.getElementById("PODAUNIT-input").value = "";
      } else {
        btn.classList.add("selected");
        unitNaoRealizada = true;
        document.getElementById("PODAUNIT-input").classList.remove("hidden");
        document.getElementById("PODAUNIT-input").value = "NÃO FOI REALIZADO PODA (Unidades)";
        document.getElementById("podaUnitExtras").classList.add("hidden");
        document.getElementById("qtdPodasUnit").value = "";
        document.getElementById("totalUnit").value = "";
      }
      gerarMensagem();
    }

    function atualizarTotalPodasUnit() {
      const qtd = document.getElementById("qtdPodasUnit").value;
      document.getElementById("totalUnit").value = qtd.trim() !== "" ? qtd : "";
    }
  
    function formatarData(data) {
      const partes = data.split("-");
      return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    
    function disableFields() {
      const formFields = document.getElementById("formFields");
      const fields = formFields.querySelectorAll("input, select, textarea, button");
      fields.forEach(field => { field.disabled = true; });
    }
    function enableFields() {
      const formFields = document.getElementById("formFields");
      const fields = formFields.querySelectorAll("input, select, textarea, button");
      fields.forEach(field => { field.disabled = false; });
    }
    
    function formatTime(totalSeconds) {
      let minutes = Math.floor(totalSeconds / 60);
      let seconds = totalSeconds % 60;
      let result = "";
      if (minutes > 0) {
        result += minutes + (minutes === 1 ? " minuto" : " minutos");
        if (seconds > 0) result += " e " + seconds + (seconds === 1 ? " segundo" : " segundos");
      } else {
        result += seconds + (seconds === 1 ? " segundo" : " segundos");
      }
      return result;
    }
    function formatFullDateTime(date) {
      const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
      let dia = date.getDate();
      let mes = meses[date.getMonth()];
      let ano = date.getFullYear();
      let horas = date.getHours();
      let minutos = date.getMinutes();
      let segundos = date.getSeconds();
      let strHoras = `${horas} ${horas === 1 ? "hora" : "horas"}`;
      let strMinutos = `${minutos} ${minutos === 1 ? "minuto" : "minutos"}`;
      let strSegundos = `${segundos} ${segundos === 1 ? "segundo" : "segundos"}`;
      return `${dia} de ${mes} de ${ano} às ${strHoras} e ${strMinutos} e ${strSegundos}`;
    }
    
    function startSprint() {
      document.getElementById('welcome-popup').style.display = 'none';
      document.getElementById('global-clock').style.display = 'block';
      globalTimerStart = Date.now();
      globalTimerInterval = setInterval(function() {
        let totalSeconds = Math.floor((Date.now() - globalTimerStart) / 1000);
        document.getElementById('global-clock').textContent = formatTime(totalSeconds);
      }, 1000);
      document.getElementById('yes-notification-popup').style.display = 'block';
      setTimeout(function() {
        document.getElementById('yes-notification-popup').style.display = 'none';
      }, 3000);
      enableFields();
      document.getElementById('clickOverlay').style.display = 'none';
      document.getElementById('body-popup').style.display = 'none';
      hideOverlay();
    }
    function handleNoSprint() {
      document.getElementById('welcome-popup').style.display = 'none';
      document.getElementById('no-notification-popup').style.display = 'block';
      setTimeout(function() {
        document.getElementById('no-notification-popup').style.display = 'none';
      }, 5000);
      document.getElementById('clickOverlay').style.display = 'block';
    }
    
    function resetSprint() {
      let popup = document.getElementById('pdf-warning-popup');
      popup.innerHTML = `
          <p>Deseja reiniciar página, todo conteúdo preenchido será perdido?</p>
          <div class="popup-buttons">
            <button onclick="confirmReset()">Sim</button>
            <button onclick="cancelReset()">Cancelar</button>
          </div>`;
      popup.style.display = 'block';
      showOverlay();
    }
    function confirmReset() {
      document.getElementById('pdf-warning-popup').style.display = 'none';
      window.location.reload();
    }
    function cancelReset() {
      document.getElementById('pdf-warning-popup').style.display = 'none';
    }
    
    function gerarMensagem() {
      let msg = `------- *DADOS DA EQUIPE* -------\n`;
      // Grupo 1: Dados da Equipe
      msg += `*TIPO DE EQUIPE:* ${document.getElementById('selectedTeamType').value.toUpperCase()}\n`;
      msg += `*NOME:* ${document.getElementById('pessoa').value.toUpperCase()}\n`;
      msg += `*LEAD:* ${document.getElementById('lead').value.toUpperCase()}\n`;
      msg += `*BR LÍDER:* ${document.getElementById('br1').value.toUpperCase()}\n\n`;

      // Grupo 2: Dados da Execução
      msg += `---- *DADOS DA DOCUMENTAÇÃO* ----\n`;
      msg += `*OT/ANE:* ${document.getElementById('ot_ane').value.toUpperCase()}\n`;
      msg += `*SGM:* ${document.getElementById('sgm').value.toUpperCase()}\n`;
      msg += `*BA:* ${document.getElementById('ba').value.toUpperCase()}\n`;
      msg += `*SGD:* ${document.getElementById('sgd').value.toUpperCase()}\n`;
      msg += `*INC:* 00${document.getElementById('inc').value.toUpperCase()}\n`;
      msg += `*DT:* ${document.getElementById('dt').value.toUpperCase()}\n`;
      msg += `*APR DIGITAL:* ${document.getElementById('apr').value.toUpperCase()}\n`;
      msg += `*APR MANUAL:* ${document.getElementById('apr2').value.toUpperCase()}\n`;
      msg += `*5RO:* ${cincoROValue.toUpperCase()}\n\n`;

      // Grupo 3: Informação de Campo
      msg += `---- *INFORMAÇÃO DE CAMPO* ----\n`;
      msg += `*TRAFO:* ${document.getElementById('traf').value.toUpperCase()}\n`;
      msg += `*TOMBAMENTO:* ${document.getElementById('Tomb').value.toUpperCase()}\n`;
      msg += `*ESTRUTURA:* ${document.getElementById('estrut').value.toUpperCase()}\n`;
      msg += `*ALIM:* ${document.getElementById('alim').value.toUpperCase()}\n`;
      msg += `*ENDEREÇO:* ${document.getElementById('endereco').value.toUpperCase()}\n\n`;

      // Grupo 4: Detalhes da Atividade
      msg += `---- *DETALHES DA ATIVIDADE* ----\n`;
      msg += `*DATA:* ${formatarData(document.getElementById('data').value).toUpperCase()}\n`;
      msg += `*HORÁRIO INÍCIO:* ${document.getElementById('start-time').value.toUpperCase()}\n`;
      msg += `*HORÁRIO FINAL:* ${document.getElementById('end-time').value.toUpperCase()}\n\n`;

      // Grupo 5: Dados de Poda
      msg += `------ *DETALHES DA PODA* ------\n`;
      // ——— Poda Unitária ———
      if (unitValues.length > 0) {
        msg += `*TIPO DE PODA UNID:* ${document.getElementById('PODAUNIT-input').value.toUpperCase()}\n`;
        const qtdUnit = document.getElementById('qtdPodasUnit').value;
        if (qtdUnit.trim() !== "") {
          msg += `*QUANTIDADE DE PODAS UNID:* ${qtdUnit}\n`;
        }
        const totalUnit = document.getElementById('totalUnit').value;
        if (totalUnit.trim() !== "") {
          msg += `*TOTAL P/ UNID:* ${totalUnit}\n`;
        }
      } else if (unitNaoRealizada) {
        msg += `*PODA P/ UNID:* NÃO FOI REALIZADO PODA POR UNIDADES\n`;
      }
      msg += `\n`;

      // ——— Poda em m² ———
      if (podaValues.length > 0) {
        msg += `*TIPO DE PODA m²:* ${document.getElementById('PODA-input').value.toUpperCase()}\n`;
        const qtdPodas = document.getElementById('qtdPodas').value;
        if (qtdPodas.trim() !== "") {
          msg += `*QUANTIDADE DE PODAS m²:* ${qtdPodas}\n`;
        }
        const m2PorPoda = document.getElementById('m2PorPoda').value;
        if (m2PorPoda.trim() !== "") {
          const totalM2 = Number(qtdPodas) * Number(m2PorPoda);
          msg += `*M² TOTAL REALIZADOS:* ${totalM2}\n`;
        }
      } else if (podaNaoRealizada) {
        msg += `*PODA P/ M²:* NÃO FOI REALIZADO PODA POR M²\n`;
      }
      msg += `\n`;

      // Grupo 6: Descrição da Atividade (campos opcionais)
      msg += `---- *DESCRIÇÃO ATIVIDADE* ----\n`;
      if (respServico === "SIM") {
        let desc = document.getElementById('descricaoServico').value;
        if (desc.trim() !== "") {
          msg += `*SERVIÇO REALIZADO*\n${desc.toUpperCase()}\n\n`;
        }
      } else if (respServico === "NÃO") {
        let note = document.getElementById('descricaoServico').value;
        if (note.trim() !== "") {
          msg += `*SERVIÇO NÃO REALIZADO MOTIVO:*\n${note.toUpperCase()}\n\n`;
        }
      }
      if (respMaterial === "SIM") {
        let desc = document.getElementById('descricaoMaterial').value;
        if (desc.trim() !== "") {
          msg += `*MATERIAL UTILIZADO*\n${desc.toUpperCase()}\n\n`;
        }
      } else if (respMaterial === "NÃO") {
        let note = document.getElementById('descricaoMaterial').value;
        if (note.trim() !== "") {
          msg += `*MATERIAL NÃO UTILIZADO MOTIVO:*\n${note.toUpperCase()}\n\n`;
        }
      }
      if (respSucata === "SIM") {
        let desc = document.getElementById('descricaoSucata').value;
        if (desc.trim() !== "") {
          msg += `*DEVOLUÇÃO SUCATA GERADA*\n${desc.toUpperCase()}\n\n`;
        }
      } else if (respSucata === "NÃO") {
        let note = document.getElementById('descricaoSucata').value;
        if (note.trim() !== "") {
          msg += `*DEVOLUÇÃO SUCATA NÃO GERADA MOTIVO:*\n${note.toUpperCase()}\n\n`;
        }
      }
      if (respRecurso === "SIM") {
        let desc = document.getElementById('descricaoRecurso').value;
        if (desc.trim() !== "") {
          msg += `*NECESSÁRIO OUTRO RECURSO?*\n${desc.toUpperCase()}\n\n`;
        }
      } else if (respRecurso === "NÃO") {
        let note = document.getElementById('descricaoRecurso').value;
        if (note.trim() !== "") {
          msg += `*NECESSÁRIO OUTRO RECURSO MOTIVO:*\n${note.toUpperCase()}\n\n`;
        }
      }
      msg += `------ *FIM RELATÓRIO* ------\n`;
      let sessionTime = "";
      if (globalTimerStart) {
        let sessionSeconds = Math.floor((Date.now() - globalTimerStart) / 1000);
        sessionTime = "*TEMPO DA SESSÃO:* " + formatTime(sessionSeconds) + "\n";
      }
      let now = new Date();
      let fullDate = formatFullDateTime(now);
      msg += `${sessionTime}${fullDate}`;

      document.getElementById('previewBox').textContent = msg;
    }
    
    function verificarCamposRespondidos() {
      let missing = [];
      let teamType = document.getElementById('selectedTeamType').value;
      if (!teamType || teamType.trim() === "") { 
          missing.push("⚠️ Tipo de Equipe");
      }

      let pessoa = document.getElementById('pessoa').value;
      if (!pessoa || pessoa === "NENHUM") { missing.push("👤 Nome do Componente"); }
      
      let lead = document.getElementById('lead').value;
      if (!lead || lead === "NENHUM") { missing.push("🏷️ LEAD"); }

      let brLider = document.getElementById('br1').value;
      if (!brLider || brLider.trim() === "" || brLider.trim().toUpperCase() === "BR") {
        missing.push("🆔 BR LÍDER");
      }
      
      let data = document.getElementById('data').value;
      if (!data || data.trim() === "") { missing.push("📅 Data"); }

      let startTime = document.getElementById('start-time').value;
      if (!startTime || startTime.trim() === "") { missing.push("🕒 Início da atividade"); }

      let endTime = document.getElementById('end-time').value;
      if (!endTime || endTime.trim() === "") { missing.push("🕒  Final da atividade"); }

      // VALIDANDO O CAMPO TIPO DE EQUIPE
      

      // ... validação dos campos de PODA e dos campos opcionais
      if ((!podaValues.length) && !podaNaoRealizada) {
          missing.push("🌳 Selecione uma opção no campo de Poda");
      } else if (podaValues.length > 0) {
          let qtdPodas = document.getElementById('qtdPodas').value;
          let m2PorPoda = document.getElementById('m2PorPoda').value;
          if (qtdPodas.trim() === "") { missing.push("🌳 Insira Qtd. total de podas realizadas"); }
          if (m2PorPoda.trim() === "") { missing.push("🌳 Insira Qtd. realizada (m²)"); }
      }

      for (let key in fieldsAnswered) {
        if (!fieldsAnswered[key]) {
          if (key === "servico") { missing.push("🔧 Serviço Realizado"); }
          else if (key === "material") { missing.push("🛠️ Material Utilizado"); }
          else if (key === "sucata") { missing.push("♻️ Devolução Sucata Gerada"); }
          else if (key === "recurso") { missing.push("❗ Necessário Outro Recurso"); }
        }
      }

      if (missing.length > 0) {
        let msg = "PREENCHA OS CAMPOS OBRIGATÓRIOS🚨<br><br>" + missing.join("<br>");
        let popup = document.getElementById('obrigatorio-popup');
        popup.innerHTML = `<p>${msg}</p>
          <div class="popup-buttons">
            <button onclick="document.getElementById('obrigatorio-popup').style.display='none';">Fechar</button>
          </div>`;
        popup.style.display = 'block';
        return false;
      }
      return true;
    }
    
    function enviarWhatsApp() {
      if (!verificarCamposRespondidos()) return;
      if (!pdfSaved) {
        let popup = document.getElementById('pdf-warning-popup');
        popup.innerHTML = `
          <p>Salve primeiro o PDF! Antes de encaminhar</p>
          <div class="popup-buttons">
            <button onclick="document.getElementById('pdf-warning-popup').style.display='none'; hideOverlay();">Fechar</button>
          </div>`;
        popup.style.display = 'block';
        showOverlay();
        return;
      }
      continuarWhatsApp();
    }
    
    function insertColon(input) {
      let value = input.value.replace(/[^0-9]/g, '');
      if (value.length >= 3) {
        value = value.slice(0, 2) + ':' + value.slice(2, 4);
      }
      if (value.length > 5) {
        value = value.slice(0, 5);
      }
      input.value = value;
    }
    
    function continuarWhatsApp() {
      document.getElementById('pdf-warning-popup').style.display = 'none';
      hideOverlay();
      const mensagem = encodeURIComponent(document.getElementById('previewBox').textContent);
      const url = `https://wa.me/?text=${mensagem}`;
      window.open(url, '_blank');
    }
    function cancelarWhatsApp() {
      document.getElementById('pdf-warning-popup').style.display = 'none';
      hideOverlay();
    }
    
    function savePdf() {
      if (!verificarCamposRespondidos()) { return; }
      gerarMensagem();
      let container = document.querySelector('.container');
      let width = container.offsetWidth;
      let height = container.offsetHeight;
      
      let lead = document.getElementById('lead').value.trim();
      let data = document.getElementById('data').value.trim();
      let ot_ane = document.getElementById('ot_ane').value.trim();
      let inc = document.getElementById('inc').value.trim();
      let endereco = document.getElementById('endereco').value.trim();
      
      if (data !== "") {
        let parts = data.split("-");
        data = parts[2] + "_" + parts[1] + "_" + parts[0];
      }
      
      lead = lead.replace(/\s+/g, "_");
      ot_ane = ot_ane.replace(/\s+/g, "_");
      inc = inc.replace(/\s+/g, "_");
      endereco = endereco.replace(/\s+/g, "_");
      
      let fileName = "RETORNO_CAMPO EXECUTADO_";
      if (lead !== "") { fileName += lead; }
      if (data !== "") { fileName += "_EM_" + data; }
      if (ot_ane !== "") { fileName += "_ATRAVÉS_OT-ANE_" + ot_ane; }
      else if (inc !== "") { fileName += "_ATRAVÉS_INCIDÊNCIA_" + inc; }
      if (endereco !== "") { fileName += "_NO_ENDERECO_" + endereco; }
      fileName += ".PDF";
      
      fileName = fileName.toUpperCase();
      
      html2pdf().set({
        margin: 0,
        filename: fileName,
        image: { type: 'jpeg', quality: 0.99 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'px', format: [width, height], orientation: 'portrait' }
      }).from(container).save().then(() => {
        let pdfButton = document.getElementById('pdfButton');
        pdfButton.textContent = 'PDF JÁ SALVO';
        pdfButton.style.backgroundColor = '#4CAF50';
        pdfButton.style.color = '#fff';
        pdfButton.style.border = '1px solid #4CAF50';
        pdfButton.disabled = true;
        pdfSaved = true;
        document.getElementById('whatsappButton').disabled = false;
      });
    }
    
    document.getElementById('clickOverlay').addEventListener('click', function(e) {
      document.getElementById('body-popup').style.display = 'block';
      e.stopPropagation();
    });
    
    function closeUpdatePopup() {
      document.getElementById('update-popup').style.display = 'none';
      document.getElementById('welcome-popup').style.display = 'block';
      hideOverlay();
    }
    
    function showOptionsPopup(field) {
      currentOptionField = field;
      let popup = document.getElementById('options-popup');
      let options = optionsForField[field] || [];
      let customMessage = messagesForField[field] || `Selecione o motivo para não realizar execução do "${field.toUpperCase()}"`;
      let html = `<p>${customMessage}</p><div class="popup-buttons">`;
      options.forEach(option => {
        html += `<button onclick="confirmOption('${field}', '${option}', this)">${option}</button>`;
      });
      html += `</div>`;
      popup.innerHTML = html;
      popup.style.display = 'block';
      showOverlay();
    }
    
    function confirmOption(field, option, btn) {
      currentOptionButton = btn;
      btn.style.backgroundColor = "#4CAF50";
      setTimeout(() => {
        let confirmPopup = document.getElementById('confirm-popup');
        confirmPopup.className = "popup-confirm";
        confirmPopup.innerHTML = `<p>Tem certeza que deseja inserir a opção marcada?</p>
          <div class="popup-buttons">
            <button class="btn-sim" onclick="finalSelectOption('${field}', '${option}')">Sim</button>
            <button class="btn-nao" onclick="cancelConfirm()">Não</button>
          </div>`;
        confirmPopup.style.display = 'block';
      }, 100);
    }
    
    function finalSelectOption(field, option) {
      document.getElementById('confirm-popup').style.display = 'none';
      selectOption(field, option);
      hideOverlay();
    }
    
    function cancelConfirm() {
      document.getElementById('confirm-popup').style.display = 'none';
      if (currentOptionButton) { 
        currentOptionButton.style.backgroundColor = "";
      }
    }
    
    function selectOption(field, optionText) {
      notas[field] = optionText;
      fieldsAnswered[field] = true;
      const container = document.getElementById(field);
      container.classList.remove('hidden');
      if (field === "servico") {
        document.getElementById('descricaoServico').value = optionText;
        respServico = "NÃO";
      } else if (field === "material") {
        document.getElementById('descricaoMaterial').value = optionText;
        respMaterial = "NÃO";
      } else if (field === "sucata") {
        document.getElementById('descricaoSucata').value = optionText;
        respSucata = "NÃO";
      } else if (field === "recurso") {
        document.getElementById('descricaoRecurso').value = optionText;
        respRecurso = "NÃO";
      }
      document.getElementById('options-popup').style.display = 'none';
      gerarMensagem();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      let elementos = document.querySelectorAll('#formFields input, #formFields select, #formFields textarea');
      elementos.forEach(elem => {
        elem.addEventListener('input', () => { lastInteraction = Date.now(); gerarMensagem(); });
        elem.addEventListener('change', () => { lastInteraction = Date.now(); gerarMensagem(); });
      });
    });
    
    function scheduleAutoPreviewUpdate() {
      let diff = Date.now() - lastInteraction;
      let interval = (diff < 2 * 60 * 1000) ? 2 * 60 * 1000 : 3 * 60 * 1000;
      setTimeout(() => { gerarMensagem(); scheduleAutoPreviewUpdate(); }, interval);
    }
    
    window.onload = function() {
      disableFields();
      document.getElementById('update-popup').style.display = 'block';
      lastInteraction = Date.now();
      scheduleAutoPreviewUpdate();
    }
    
    function enforcePrefix(e, prefix) {
      const input = e.target;
      setTimeout(() => {
        if (input.selectionStart < prefix.length) {
          input.setSelectionRange(prefix.length, prefix.length);
        }
      }, 0);
    }
    
    function fixPrefixInput(el, prefix) {
      let currentVal = el.value;
      if (currentVal.length < prefix.length) {
        el.value = prefix;
        el.setSelectionRange(prefix.length, prefix.length);
      } else if (!currentVal.toUpperCase().startsWith(prefix)) {
        let withoutPrefix = currentVal.replace(new RegExp('^' + prefix, 'i'), '');
        el.value = prefix + withoutPrefix;
        el.setSelectionRange(prefix.length, prefix.length);
      }
    }
    // Função que marca o botão clicado e preenche o campo read-only
    function selectTeamType(teamType, btn) {
      // Remove a classe 'selected' de todos os botões
      const buttons = document.querySelectorAll('#teamButtons button');
      buttons.forEach(b => b.classList.remove('selected'));
      // Adiciona a classe 'selected' ao botão clicado
      btn.classList.add('selected');
      // Preenche o campo somente leitura com o valor escolhido
      document.getElementById('selectedTeamType').value = teamType;
    }
    
    // Função para carregar os componentes
    function carregarComponentes() {
      fetch('componentes.json')
        .then(response => response.json())
        .then(data => {
          const componentesSelect = document.getElementById('pessoa');
          data.componentes.forEach(componente => {
            let option = document.createElement('option');
            option.value = componente;
            option.text = componente;
            componentesSelect.appendChild(option);
          });
        })
        .catch(error => console.error('Erro ao carregar componentes:', error));
    }

    // Função para carregar os leads
    function carregarLeads() {
      fetch('leads.json')
        .then(response => response.json())
        .then(data => {
          const leadsSelect = document.getElementById('lead');
          data.leads.forEach(lead => {
            let option = document.createElement('option');
            option.value = lead.lead;
            option.text = lead.lead;
            leadsSelect.appendChild(option);
          });
        })
        .catch(error => console.error('Erro ao carregar leads:', error));
    }

    // Chama as funções de carregamento
    document.addEventListener('DOMContentLoaded', function() {
      carregarComponentes();
      carregarLeads();
    });
  </script>
</body>
</html>
